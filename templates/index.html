<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Recognizer</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background-color: black;
      color: white;
      font-family: "Segoe UI", sans-serif;
      height: 100vh;
      overflow: hidden;
    }

    h1 {
      font-size: 3em;
      font-weight: bold;
      margin: 30px 0 20px 40px;
      color: violet;
    }

    .container {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 20px 40px;
      box-sizing: border-box;
      height: calc(100vh - 70px);
    }

    .controls {
      width: 260px;
      display: flex;
      flex-direction: column;
      padding-left: 20px;
    }

    .section-title {
      color: violet;
      font-size: 1.2em;
      margin: 25px 0 12px 5px;
    }

    button {
      font-size: 1em;
      font-weight: bold;
      padding: 10px 20px;
      margin: 5px 10px 5px 0;
      border: none;
      cursor: pointer;
      border-radius: 5px;
      background: linear-gradient(90deg, #c850c0, #4158d0);
      color: black;
    }

    .video-section {
      flex-grow: 1;
      margin-left: 200px;
      margin-right: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .video-section h2 {
      font-size: 1.2em;
      margin-bottom: 15px;
    }

    .video-box {
      width: 900px;
      height: 450px;
      background: #222;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }

    .video-box video {
      width: auto; 
      height: auto;
      max-width: 100%;
      max-height: 100%; 
      display: none;
      object-fit: contain;
    }

    #overlayCanvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      display: none;
    }

    .placeholder {
      color: gray;
      position: absolute;
    }

    #alertMessage {
      display: block;
      position: fixed;
      top: -50px;
      left: 0;
      width: 100%;
      background-color: #ff3e3e;
      color: white;
      text-align: center;
      padding: 12px 0;
      font-weight: bold;
      z-index: 1000;
      font-family: 'Segoe UI', sans-serif;
      transition: top 0.5s ease;
    }
  </style>
</head>
<body>
  <!-- ALERT MESSAGE -->
  <div id="alertMessage"></div>

  <h1>AI RECOGNITION</h1>
  <div class="container">
    <!-- Left panel -->
    <div class="controls">
      <!-- Live Webcam -->
      <div class="section-title">Live Webcam</div>
      <div style="margin-left:5px;">
        <button id="startBtn">Start</button>
        <button id="stopBtn">Stop</button>
      </div>
    </div>

    <!-- Right panel -->
    <div class="video-section">
      <h2>AI Detector</h2>
      <div class="video-box">
        <span class="placeholder">[ Live webcam will appear here ]</span>
        <video id="webcam" autoplay playsinline></video>
        <canvas id="overlayCanvas"></canvas>
      </div>
    </div>
  </div>

<script>
const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");
const webcam = document.getElementById("webcam");
const overlayCanvas = document.getElementById("overlayCanvas");
const ctx = overlayCanvas.getContext("2d");
const placeholder = document.querySelector(".placeholder");

let liveStream = null;
let isWebcamRunning = false;
let trackedFaces = [];
let faceClasses = {};
let faceCounter = 1;

// ---------- Alert ----------
function showAlert(msg){
  const alertDiv = document.getElementById("alertMessage");
  alertDiv.textContent = msg;
  alertDiv.style.top = "0";
  setTimeout(()=>{ alertDiv.style.top="-50px"; }, 3000);
}

// ---------- Assign Classes ----------
function assignClassToFace(face){
  const key = `${Math.round(face.x/25)}-${Math.round(face.y/25)}-${Math.round(face.w/25)}-${Math.round(face.h/25)}`;
  if(faceClasses[key]) return faceClasses[key];
  const newClass = "Person " + faceCounter++;
  faceClasses[key] = newClass;
  return newClass;
}

// ---------- Draw bounding boxes ----------
function drawBoxes(faces){
  ctx.clearRect(0,0,overlayCanvas.width, overlayCanvas.height);
  faces.forEach(face=>{
    let {x,y,w,h,name,confidence} = face;
    let displayName = (!name || name==="Unknown" || (confidence!==undefined && confidence<0.7))
      ? assignClassToFace(face)
      : name;

    ctx.strokeStyle = (displayName.startsWith("Person")) ? "#FF3B30" : "#00FF00";
    ctx.lineWidth = 3;
    ctx.strokeRect(x,y,w,h);
    ctx.fillStyle = ctx.strokeStyle;
    ctx.font = "18px 'Segoe UI'";
    ctx.fillText(displayName, x, y > 20 ? y-5 : y+20);
  });
}

// ---------- Send image to backend ----------
async function sendImageToBackend(file){
  const formData = new FormData();
  formData.append("image", file);
  try {
    const res = await fetch("/recognize", { method: "POST", body: formData });
    const data = await res.json();
    return data.faces || [];
  } catch(err) {
    showAlert("Backend error: " + err.message);
    return [];
  }
}

// ---------- Webcam Detection ----------
startBtn.addEventListener("click", async () => {
  try {
    liveStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
    webcam.srcObject = liveStream;
    webcam.style.display = "block";
    placeholder.style.display = "none";

    webcam.onloadedmetadata = () => {
      overlayCanvas.width = webcam.videoWidth || 640;
      overlayCanvas.height = webcam.videoHeight || 480;
      overlayCanvas.style.display = "block";
    };

    isWebcamRunning = true;

    const processWebcam = async () => {
      if(!isWebcamRunning) return;
      if (webcam.videoWidth === 0 || webcam.videoHeight === 0) {
        requestAnimationFrame(processWebcam);
        return;
      }

      const canvas = document.createElement("canvas");
      canvas.width = webcam.videoWidth;
      canvas.height = webcam.videoHeight;
      canvas.getContext("2d").drawImage(webcam,0,0);

      const blob = await new Promise(res=>canvas.toBlob(res,"image/jpeg"));
      const faces = await sendImageToBackend(new File([blob],"webcam.jpg",{type:"image/jpeg"}));

      trackedFaces = faces.length>0 ? faces : trackedFaces;
      drawBoxes(trackedFaces);
      requestAnimationFrame(processWebcam);
    };
    requestAnimationFrame(processWebcam);
  } catch(err){
    showAlert("Could not access webcam: " + err.message);
  }
});

stopBtn.addEventListener("click", () => {
  if(liveStream) liveStream.getTracks().forEach(t=>t.stop());
  webcam.srcObject = null;
  webcam.style.display = "none";
  overlayCanvas.style.display = "none";
  placeholder.style.display = "block";
  ctx.clearRect(0,0,overlayCanvas.width, overlayCanvas.height);
  trackedFaces = [];
  faceClasses = {};
  faceCounter = 1;
  isWebcamRunning = false;
});
</script>
</body>
</html>